// services/quizGenerator.ts
import { ChatOpenAI } from "@langchain/openai";
import { ChatPromptTemplate } from "@langchain/core/prompts";
import { quizResponseSchema } from "../schemas/quizSchema.ts"; // ìœ„ì—ì„œ ë§Œë“  ìŠ¤í‚¤ë§ˆ

export async function generateQuizWithLangChain(
  text: string,
  config: { type: string; count: number; difficulty: string }
) {
  // Deno í™˜ê²½ì—ì„œëŠ” Deno.env.get()ìœ¼ë¡œ í™˜ê²½ ë³€ìˆ˜ë¥¼ ê°€ì ¸ì™€ì•¼ í•¨
  const OPENAI_API_KEY = Deno.env.get("OPENAI_API_KEY");

  // ğŸ’¡ í‚¤ê°€ ì—†ìœ¼ë©´ ë°”ë¡œ ì—ëŸ¬ ë˜ì§€ê¸° (ë””ë²„ê¹…ì— ë„ì›€ë¨)
  if (!OPENAI_API_KEY) {
    throw new Error(
      "OPENAI_API_KEY environment variable is not set in the Deno runtime."
    );
  }
  // 1. ëª¨ë¸ ì„¤ì • (gpt-4o-mini ì¶”ì²œ)
  const model = new ChatOpenAI({
    modelName: "gpt-4o-mini",
    temperature: 0.7, // ì°½ì˜ì„± ì¦ê°€ (0.5 -> 0.7)
    apiKey: OPENAI_API_KEY,
  });

  // 2. Structured Output ì„¤ì • (í•µì‹¬!)
  // ëª¨ë¸ì—ê²Œ Zod ìŠ¤í‚¤ë§ˆë¥¼ ì£¼ì…í•´ì„œ, ë¬´ì¡°ê±´ ì´ í˜•íƒœì˜ JSONì„ ë±‰ê²Œ ë§Œë“¦
  const structuredLlm = model.withStructuredOutput(quizResponseSchema);

  // 3. í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ì‘ì„±
  const prompt = ChatPromptTemplate.fromMessages([
    [
      "system",
      `ë‹¹ì‹ ì€ ì „ë¬¸ êµìœ¡ ì „ë¬¸ê°€ì´ì í€´ì¦ˆ ì œì‘ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì£¼ì–´ì§„ í•™ìŠµ ìë£Œë¥¼ ê¹Šì´ ìˆê²Œ ë¶„ì„í•˜ì—¬ ê³ í’ˆì§ˆì˜ êµìœ¡ì  ê°€ì¹˜ê°€ ë†’ì€ í€´ì¦ˆë¥¼ ìƒì„±í•˜ì„¸ìš”.

[ìš”ì²­ ì •ë³´]
- í€´ì¦ˆ ìœ í˜•: {type}
- ë‚œì´ë„: {difficulty}
- ìƒì„± ê°œìˆ˜: {count}ê°œ

[í•µì‹¬ ì›ì¹™ - ë°˜ë“œì‹œ ì¤€ìˆ˜í•˜ì„¸ìš”!]
1. **ìë£Œì˜ ë‹¨ìˆœ ë³µì‚¬ ê¸ˆì§€**: ìë£Œì˜ ë¬¸ì¥ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì§€ ë§ê³ , ë‹¤ì–‘í•œ ê°ë„ì™€ í‘œí˜„ìœ¼ë¡œ ì§ˆë¬¸ì„ ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤.
2. **êµ¬ì²´ì ì´ê³  ëª…í™•í•œ ì§ˆë¬¸**: ëª¨í˜¸í•˜ê±°ë‚˜ ì¶”ìƒì ì¸ ì§ˆë¬¸ì„ í”¼í•˜ê³ , í•™ìŠµìê°€ ì •í™•íˆ ë¬´ì—‡ì„ ë‹µí•´ì•¼ í•˜ëŠ”ì§€ ëª…í™•í•´ì•¼ í•©ë‹ˆë‹¤.
3. **êµìœ¡ì  ê°€ì¹˜**: ë‹¨ìˆœ ì•”ê¸°ê°€ ì•„ë‹Œ ì´í•´ì™€ ì ìš©ì„ í™•ì¸í•˜ëŠ” ì§ˆë¬¸ì„ ìš°ì„ ì‹œí•˜ì„¸ìš”.
4. **ë¬¸ì œ ê°„ ë‹¤ì–‘ì„±**: ê°™ì€ ì£¼ì œë¼ë„ ë‹¤ë¥¸ ê´€ì , ë‹¤ë¥¸ ë‚œì´ë„, ë‹¤ë¥¸ ì ‘ê·¼ ë°©ì‹ìœ¼ë¡œ ì§ˆë¬¸í•´ì•¼ í•©ë‹ˆë‹¤.
5. **ì •í™•í•œ ë‹µë³€**: ë‹µë³€(answer)ì€ ìë£Œì— ëª…ì‹œëœ ì •í™•í•œ ë‚´ìš©ì´ì–´ì•¼ í•©ë‹ˆë‹¤.

[ë‚œì´ë„ë³„ ìƒì„¸ ê°€ì´ë“œ]

**Easy (ì‰¬ì›€) - {difficulty}ê°€ "easy"ì¼ ë•Œ:**
- ìë£Œì— **ì§ì ‘ì ìœ¼ë¡œ ëª…ì‹œëœ ì‚¬ì‹¤**ì„ ë¬»ëŠ” ì§ˆë¬¸
- ì˜ˆ: "Chromeì˜ ìë°”ìŠ¤í¬ë¦½íŠ¸ ì—”ì§„ ì´ë¦„ì€ ë¬´ì—‡ì¸ê°€ìš”?" â†’ ë‹µ: "V8"
- ì˜ˆ: "ë°±ì—”ë“œëŠ” ì‚¬ìš©ìì˜ ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” (    ) ì˜ì—­ì…ë‹ˆë‹¤." â†’ ë‹µ: "ë³´ì´ì§€ì•ŠëŠ”"
- ì§ˆë¬¸ì€ ì¹œì ˆí•˜ê³  ëª…í™•í•˜ê²Œ ì‘ì„±

**Medium (ë³´í†µ) - {difficulty}ê°€ "medium"ì¼ ë•Œ:**
- ìë£Œì˜ **ë‘ ê°œ ì´ìƒì˜ ê°œë…ì„ ì—°ê²°**í•˜ê±°ë‚˜ **ê°„ë‹¨í•œ ì¶”ë¡ **ì´ í•„ìš”í•œ ì§ˆë¬¸
- ì˜ˆ: "ë¸Œë¼ìš°ì €ì™€ Node.jsì˜ ê³µí†µì ì€ ë¬´ì—‡ì¸ê°€ìš”?" â†’ ë‹µ: "ìë°”ìŠ¤í¬ë¦½íŠ¸ì—”ì§„ì‚¬ìš©"
- ì˜ˆ: "ë°±ì—”ë“œê°€ ë°ì´í„°ë² ì´ìŠ¤ì™€ í†µì‹ í•˜ëŠ” ì´ìœ ëŠ” ë¬´ì—‡ì¸ê°€ìš”?" â†’ ë‹µ: "CRUDì‘ì—…ìˆ˜í–‰"
- ì§ˆë¬¸ì€ ì•½ê°„ì˜ ì‚¬ê³ ë¥¼ ìš”êµ¬í•˜ë˜ ë„ˆë¬´ ì–´ë µì§€ ì•Šê²Œ

**Hard (ì–´ë ¤ì›€) - {difficulty}ê°€ "hard"ì¼ ë•Œ:**
- ìë£Œì˜ **ì‹¬ì¸µì  ì´í•´**ë‚˜ **ë¹„êµ ë¶„ì„**, **ì˜ˆì™¸ ìƒí™©**ì„ ë¬»ëŠ” ì§ˆë¬¸
- ì˜ˆ: "ë‹¤ìŒ ì¤‘ Node.jsì™€ ê°€ì¥ ê±°ë¦¬ê°€ ë¨¼ ê²ƒì€?" â†’ ë‹µ: "ë¸Œë¼ìš°ì €"
- ì˜ˆ: "ìë°”ìŠ¤í¬ë¦½íŠ¸ê°€ ë¸Œë¼ìš°ì € ë°–ì—ì„œ ì‹¤í–‰ë˜ì§€ ì•ŠëŠ” ì´ìœ ëŠ” ë¬´ì—‡ì¸ê°€ìš”?" â†’ ë‹µ: "ì—”ì§„ë¶€ì¬"
- ì§ˆë¬¸ì€ ë¹„íŒì  ì‚¬ê³ ì™€ ì¢…í•©ì  ì´í•´ë¥¼ ìš”êµ¬

[ìœ í˜•ë³„ ìƒì„¸ ê°€ì´ë“œ]

**ë‹¨ë‹µí˜•(short_answer) - {type}ì´ "short_answer"ì¼ ë•Œ:**
- 'options'ëŠ” ë°˜ë“œì‹œ ë¹ˆ ë°°ì—´([])ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
- **'answer'ëŠ” ë°˜ë“œì‹œ ë„ì–´ì“°ê¸° ì—†ëŠ” í•œ ë‹¨ì–´ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.**
  * âœ… ì˜¬ë°”ë¥¸ ì˜ˆ: "V8", "ë°±ì—”ë“œ", "ëŸ°íƒ€ì„", "123"
  * âŒ ì˜ëª»ëœ ì˜ˆ: "V8, SpiderMonkey" (ì—¬ëŸ¬ ë‹¨ì–´), "ë°ì´í„°ë² ì´ìŠ¤ í†µì‹ " (ë„ì–´ì“°ê¸° ìˆìŒ), "CRUD ì‘ì—… ìˆ˜í–‰" (ë¬¸ì¥ í˜•íƒœ), "ë³´ì´ì§€ì•ŠëŠ”" (í˜•ìš©ì‚¬ ë˜ëŠ” ë¶€ì‚¬ í˜•íƒœ)
- ë‹µë³€ì´ ì—¬ëŸ¬ ê°œë…ì„ í¬í•¨í•´ì•¼ í•˜ëŠ” ê²½ìš°, ì§ˆë¬¸ì„ í•œ ë‹¨ì–´ë¡œ ë‹µí•  ìˆ˜ ìˆë„ë¡ ì¬êµ¬ì„±í•˜ì„¸ìš”.
  * ì˜ˆ: "Chromeì˜ ìë°”ìŠ¤í¬ë¦½íŠ¸ ì—”ì§„ì€?" â†’ ë‹µ: "V8" (ë‹¨ì¼ ë‹µë³€)
  * ì˜ˆ: "ë‘˜ ì‚¬ì´ì˜ ë‹¤íˆ¼ì—ì„œ ì œ 3ìê°€ ì´ë“ì„ ë³¸ë‹¤ëŠ” ëœ»ì˜ ì‚¬ìì„±ì–´ëŠ”?" â†’ ë‹µ: "ì–´ë¶€ì§€ë¦¬"
- **ì§ˆë¬¸ í˜•íƒœ ë‹¤ì–‘í™”**: ì¼ë°˜ ì§ˆë¬¸ë¿ë§Œ ì•„ë‹ˆë¼ ê°€ë” ë¹ˆì¹¸ ì±„ìš°ê¸° í˜•íƒœë„ ì‚¬ìš©í•˜ì„¸ìš”.
  * ë¹ˆì¹¸ ì±„ìš°ê¸° ì˜ˆì‹œ:
    - "ìš°ë¦¬ë‚˜ë¼ ìµœì´ˆì˜ í•œê¸€ ì†Œì„¤ë¡œ ì „í•´ì§€ëŠ” ê³ ì „ì†Œì„¤ì€ (    )ì…ë‹ˆë‹¤." â†’ ë‹µ: "í™ê¸¸ë™ì „"
    - "í‰ì°½ë™ê³„ì˜¬ë¦¼í”½ì´ ì—´ë ¸ë˜ í•´ëŠ” (    )ë…„ë„ ì´ë‹¤" â†’ ë‹µ: "2018"
  * ë¹ˆì¹¸ ì±„ìš°ê¸°ëŠ” ì „ì²´ ë¬¸ì œì˜ 20~30% ì •ë„ë¡œ ì ì ˆíˆ ì„ì–´ì„œ ì‚¬ìš©í•˜ì„¸ìš”.

**ê°ê´€ì‹(multiple_choice) - {type}ì´ "multiple_choice"ì¼ ë•Œ:**
- 'options' ë°°ì—´ì— ë°˜ë“œì‹œ 5ê°œì˜ ë³´ê¸°ë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.
- ì •ë‹µì€ options ë°°ì—´ì— í¬í•¨ë˜ì–´ì•¼ í•˜ë©°, answerëŠ” ì •ë‹µ í…ìŠ¤íŠ¸ì™€ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.
- ì˜¤ë‹µ ë³´ê¸°ëŠ” ìë£Œì˜ ë‹¤ë¥¸ ê°œë…ì´ë‚˜ ìœ ì‚¬í•˜ì§€ë§Œ í‹€ë¦° ë‚´ìš©ìœ¼ë¡œ êµ¬ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

[ì§ˆë¬¸ ì‘ì„± ê°€ì´ë“œ]
1. **ë‹¤ì–‘í•œ ì§ˆë¬¸ ìœ í˜• ì‚¬ìš©**:
   - "~ë€ ë¬´ì—‡ì¸ê°€ìš”?" (ì •ì˜)
   - "~ì˜ ì—­í• ì€ ë¬´ì—‡ì¸ê°€ìš”?" (ê¸°ëŠ¥)
   - "~ì˜ ì˜ˆì‹œë¥¼ ë“¤ë©´?" (ì ìš©)
   - "~ì˜ ì°¨ì´ì ì€?" (ë¹„êµ)
   - "~ê°€ í•„ìš”í•œ ì´ìœ ëŠ”?" (ì´í•´)
   - "ë‹¤ìŒ ì¤‘ ~ì¸ ê²ƒì€?" (ì„ íƒ)
   - "~ëŠ” (    )ì…ë‹ˆë‹¤." (ë¹ˆì¹¸ ì±„ìš°ê¸°) - ë‹¨ë‹µí˜•ì—ì„œ ê°€ë” ì‚¬ìš©

2. **êµ¬ì²´ì ì¸ ìƒí™© ì œì‹œ**:
   - "ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ë°±ì—”ë“œê°€ í•˜ëŠ” ì¼ì€?" (êµ¬ì²´ì )
   - "ë°±ì—”ë“œì˜ ì—­í• ì€?" (ë„ˆë¬´ ì¶”ìƒì ) âŒ

3. **ì¤‘ë³µ ë°©ì§€**:
   - ê°™ì€ ê°œë…ì„ ë‹¤ë¥¸ ë°©ì‹ìœ¼ë¡œ ì§ˆë¬¸
   - ì˜ˆ: ë¬¸ì œ1ì—ì„œ "ë°±ì—”ë“œ ì •ì˜"ë¥¼ ë¬¼ì—ˆë‹¤ë©´, ë¬¸ì œ2ì—ì„œëŠ” "ë°±ì—”ë“œ ì˜ˆì‹œ" ë˜ëŠ” "ë°±ì—”ë“œì™€ í”„ë¡ íŠ¸ì—”ë“œ ì°¨ì´" ë“±ìœ¼ë¡œ ì§ˆë¬¸

[í•´ì„¤ ì‘ì„± ê°€ì´ë“œ]
- í•´ì„¤ì€ **ìµœì†Œ 2ë¬¸ì¥ ì´ìƒ**ìœ¼ë¡œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.
- ì²« ë²ˆì§¸ ë¬¸ì¥: ì •ë‹µì´ ë¬´ì—‡ì¸ì§€ ëª…í™•íˆ ì œì‹œ
- ë‘ ë²ˆì§¸ ë¬¸ì¥ ì´í›„: ì™œ ê·¸ ë‹µì´ ë§ëŠ”ì§€, ìë£Œì˜ ì–´ë–¤ ë¶€ë¶„ì—ì„œ ë‚˜ì˜¨ ê²ƒì¸ì§€, ì¶”ê°€ ì„¤ëª…ì´ë‚˜ ë§¥ë½ ì œê³µ
- ì˜ˆì‹œ:
  âœ… ì¢‹ì€ í•´ì„¤: "Chromeì˜ ìë°”ìŠ¤í¬ë¦½íŠ¸ ì—”ì§„ì€ V8ì…ë‹ˆë‹¤. V8ì€ êµ¬ê¸€ì´ ê°œë°œí•œ ì˜¤í”ˆì†ŒìŠ¤ ì—”ì§„ìœ¼ë¡œ, Chromeë¿ë§Œ ì•„ë‹ˆë¼ Node.jsì—ì„œë„ ì‚¬ìš©ë©ë‹ˆë‹¤."
  âŒ ë‚˜ìœ í•´ì„¤: "Chromeì€ V8 ì—”ì§„ì„ ì‚¬ìš©í•©ë‹ˆë‹¤."

[ìƒì„± ì‹œ ì²´í¬ë¦¬ìŠ¤íŠ¸]
ê° í€´ì¦ˆë¥¼ ìƒì„±í•  ë•Œ ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:
âœ“ ì§ˆë¬¸ì´ ìë£Œì˜ ë¬¸ì¥ì„ ê·¸ëŒ€ë¡œ ë³µì‚¬í•˜ì§€ ì•Šì•˜ëŠ”ê°€?
âœ“ ì§ˆë¬¸ì´ êµ¬ì²´ì ì´ê³  ëª…í™•í•œê°€?
âœ“ ë‹µë³€ì´ ì •í™•í•˜ê³  **ë„ì–´ì“°ê¸° ì—†ëŠ” í•œ ë‹¨ì–´**ì¸ê°€? (ë‹¨ë‹µí˜•ì˜ ê²½ìš°)
âœ“ í•´ì„¤ì´ 2ë¬¸ì¥ ì´ìƒì´ê³  êµìœ¡ì  ê°€ì¹˜ê°€ ìˆëŠ”ê°€?
âœ“ ì´ì „ ë¬¸ì œì™€ ë‹¤ë¥¸ ê´€ì ì´ë‚˜ ì ‘ê·¼ ë°©ì‹ì¸ê°€?
âœ“ ë‚œì´ë„ì— ë§ëŠ” ìˆ˜ì¤€ì¸ê°€?
âœ“ ë‹¨ë‹µí˜•ì¸ ê²½ìš° ë¹ˆì¹¸ ì±„ìš°ê¸° í˜•íƒœë¥¼ ì ì ˆíˆ í¬í•¨í–ˆëŠ”ê°€? (20~30% ì •ë„)

í˜„ì¬ ìš”ì²­: {type} ìœ í˜•, {difficulty} ë‚œì´ë„, {count}ê°œ ìƒì„±

ëª¨ë“  ì‘ë‹µì€ ì£¼ì–´ì§„ JSON í¬ë§·ì„ ì—„ê²©íˆ ì¤€ìˆ˜í•´ì•¼ í•©ë‹ˆë‹¤.`,
    ],
    [
      "human",
      `ë‹¤ìŒ í•™ìŠµ ìë£Œë¥¼ ë¶„ì„í•˜ì—¬ {count}ê°œì˜ {type} ìœ í˜• í€´ì¦ˆë¥¼ {difficulty} ë‚œì´ë„ë¡œ ìƒì„±í•˜ì„¸ìš”.

í•™ìŠµ ìë£Œ:
{text}

ì£¼ì˜ì‚¬í•­:
- ê° ë¬¸ì œëŠ” ì„œë¡œ ë‹¤ë¥¸ ê´€ì ê³¼ ì ‘ê·¼ ë°©ì‹ìœ¼ë¡œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.
- ë‹¨ë‹µí˜•ì¸ ê²½ìš°, ë‹µë³€ì€ ë°˜ë“œì‹œ ë„ì–´ì“°ê¸° ì—†ëŠ” í•œ ë‹¨ì–´ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.
- ë‹¨ë‹µí˜•ì¸ ê²½ìš°, ì „ì²´ ë¬¸ì œì˜ 20~30% ì •ë„ëŠ” ë¹ˆì¹¸ ì±„ìš°ê¸° í˜•íƒœë¡œ ì‘ì„±í•˜ì„¸ìš”.
- í•´ì„¤ì€ ìƒì„¸í•˜ê³  êµìœ¡ì ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.`,
    ],
  ]);

  // 4. ì²´ì¸ ì—°ê²° (Prompt -> Model -> JSON Output)
  const chain = prompt.pipe(structuredLlm);

  // 5. ì‹¤í–‰
  try {
    const result = await chain.invoke({
      type: config.type, // ê°ê´€ì‹ : multiple_choice, ë‹¨ë‹µí˜• : short_answer
      difficulty: config.difficulty, // hard, medium, easy
      count: config.count, // 5~10
      text: text.substring(0, 20000), // í† í° ì œí•œ ì•ˆì „ì¥ì¹˜ í…ìŠ¤íŠ¸ 5000ì, 10page PDF 1ê°œ 15000 ê¸°ì¤€
    });

    return result; // ì—¬ê¸°ì„œ ì´ë¯¸ ì™„ë²½í•œ JSON ê°ì²´ê°€ ë°˜í™˜ë¨ (íŒŒì‹± ë¶ˆí•„ìš”!)
  } catch (error) {
    console.error("Quiz Generation Error:", error);
    throw new Error("í€´ì¦ˆ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
}
